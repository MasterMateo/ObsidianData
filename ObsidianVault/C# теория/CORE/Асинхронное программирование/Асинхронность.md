#CSharp 

Асинхронность позволяет вынести отдельные задачи из основного потока в специальные асинхронные методы(вторичные потоки) и при этом более экономно использовать потоки
https://habr.com/ru/companies/otus/articles/488082/

## Машина состояний(IAsyncStateMachine)

Асинхронный метод преобразуется компилятором в метод заглушку, в котором происходит инициализация сгенерированного класса - машины состояний. 

В этом классе создаются поля в которые запоминается состояние переменных метода. С помощью метода `MoveNext()` машина состояний разбивает код на части между каждым вызовом `await`, который выполняется при переходах конечного автомата между состояниями, так что поток может покинуть метод, и когда он вернется, состояние не изменится.
##  ConfigureAwait()

Все что идет после `await` называется `Continuation Task`, код который идет до `await` исполняется синхронно. Код вызываемый в `await` исполняется на другом потоке.

ConfigureAwait() используется для того чтобы контрллировать на каком из потоков будет выполняться `Continuation Task`

```C#
private async void Button_Click(object sender, RoutedEvent Args e)
{
	Consile.Writeline("Код перед асинхронным методом");
	
	await DoWorkAsync().ConfigureAwait(false);
	
	Consile.Writeline("Код Continuation Task");
	_button.BackGroung = new SolidColorBrush(Colors.Green);
}
```

В данном случае указав `ConfigureAwait(false)` мы говорим коду в `Continuation Task` оставаться в том же потоке, что и метод `DoWorkAsync()` вместо того, чтобы вернуться в свой. Это приведет к ошибке так как, поток `await DoWorkAsync()` ничего не знает о переменной `_button` потому что она существует в контекте начального потока

ConfigureAwait(true) - дефолтное значение, используется при работе с UI
ConfigureAwait(false) - используется при разработке библиотеки 

### IAsyncEnumerable
  
До C# 8 и .NET Core 3.0 не было возможности использовать блок-итератор (yield) в асинхронном методе, что усложняло жизнь и заставляло из такого метода возвращать Task<IEnumerable<T>>, т.е. не было способа проитерироваться по коллекции до полного ее получения. Для этого тип возвращаемого значения должен быть IAsyncEnumerable<T> (или IAsyncEnumerator<T>). Для прохода по такой коллекции следует использовать цикл foreach с ключевым словом await.