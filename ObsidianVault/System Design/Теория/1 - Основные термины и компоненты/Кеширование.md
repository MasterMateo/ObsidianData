#SystemDesign 

- Сокращение response time сервисов
- Снижение лишней нагрузки на сторонние сервисы
- Переиспользование ранее полученных или вычисленных данных
- Стабилизация работы при кратковременных отказах систем

## Основные термины

1. **Cache miss** - промах кеша, запрошенный ключ не был найден в кеше
2. **Cache Hit** - попадание в кеш, запрошенный ключ найден в кеше
3. **Hit ratio** - процент попаданий запросов в кеш, характеризует эффективность кеширования
4. **Горячий ключ** - ключ, на который приходится большая часть запросов
5. **Прогрев кеша** - процесс наполнения кеша данными
6. **Инвалидация** - удаление кешированных данных

### Какие данные кешировать
- Меняются часто (секунды) - кешировать чаще всего бессмысленно, но иногда может пригодиться
- Меняются не часто (минуты и часы) - чаще всего здесь задаемся вопросом - "стоит ли мне кешировать"
- Меняются редко (дни, недели, месяцы) - в данном случае можно спокойно кешировать эти данные

### Кеширование ошибок
Кешируем ошибки и тогда последующие запросы не будут обращаться к источнику информации(кешируем не только данные, но и их отсутствие), а так же не будет **cache miss attack**(приложение должно уметь держать нагрузку без кеша, задача кеша - ускорить ответ, а не держать нагрузку)

### Эффективность

>AverageTime = DBAccessTime * CacheMissRate + CacheAccessTime

Пусть:
- DBAccessTime = 100 ms
- CacheAccessTime = 20 ms
Тогда при CacheMissRate > 0.8 - кеш вреден!

### Виды кеширования
- ==Внутреннее кеширование==(сервис хранит в себе какие-то данные, является statefull)
	- Высокая скорость 
	- Отсутствие сетевых запросов
	- Нет расходов на Marshaling / Unmarshaling данных(это время которое надо на то чтобы "собрать" / "разобрать" запрос)
	- Трудности с горизонтальным масштабированием
	- Прогрев кеша после падения сервиса
- ==Внешнее кеширование==(сервис ходит за данными во внешний storage)
	- Хранение большого объема данных
	- Простое горизонтальное масштабирование
	- После падения сервиса данные кеша не теряются
	- Простой прогрев кеша и простая логика инвалидации(все в одном месте, а не в каждом сервисе отдельно)
	- Медленнее скорость работы 

### Способы взаимодействия с кешом
1. ==Cache Aside==(Кеширование на стороне) - в этой стратегии, приложение координирует запросы в кеш и БД и само решает, куда в какой момент нужно обращаться. [[Cache-Aside]] - медленно работает на запись и на чтение, можно отказаться от некоторых операций в угоду скорости, но с потерей консистентности. Так же можно сохранять данные в бд асинхронно батчами
2. ==Cache Through==(Сквозное кеширование) - в рамках этой стратегии все запросы от приложения проходят через кеш. Приложение знает только про кеш и не знает про БД. [[Cache Through]]. Необходима доп инфрастуктура(воркер), которая будет ходить в бд, если в кеше нету данных, записывать данные в бд, прогревать кеш, так как при падении кеша падает приложение. Runtime гораздо меньше, поддерживать сложнее
3. ==Cache Ahead==(Опережающее кеширование) - запросы на чтение/запись/оба всегда идут только в кеш, никогда не попадая в БД напрямую. [[Cache-ahead]]. Кеш не тратит latency на хождение в БД, только периодически выгружает/загружает данные в БД

### Резюме
- Важно учитывать актуализацию данных
- Стоит балансировать между характером нагрузки ( какая нагрузка преобладает чтение или запись)
- Также не забыть про отказоустойчивость

[[Алгоритмы вытеснения данных]]