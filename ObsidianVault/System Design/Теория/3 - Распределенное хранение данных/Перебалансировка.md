#SystemDesign 

Как перенести данные из одного шарда на другой?

>[!info] Если можно не шардировать БД, то лучше не шардировать!

### Virtual buckets

Можно сделать виртуальные шарды, приложения или координаторы будут считать, что общаются с шардами, но на самом деле это будет виртуальные бакеты

Преимущества подхода:
1. При переливе данных, см. [[virtual-buckets]]. Пользователь как знал, так и будет знать, что у нас 7 виртуальных бакетов, при переливе данных с шарда 1 на шард 2, код пользователя не будет нуждаться в обновлении(он даже не будет знать об этом), так как это ==другой уровень абстракции!==
2. При добавлении еще одного физического шарда, количество виртуальных бакетов не изменится (так же остается остаток от деления на 7). 
>[!info]- Добавление шарда без virtual buckets
> В этом случае часть данных начинает ехать на новый шард(то есть теперь берем остаток от деления на 3), в результате чего данные расплываются по всем шардам


### Варианты перебалансировки:
1. Только чтение(если бизнес позволяет, можно перелить данные ночью, запрещаем все модифицирующие данные операции в БД)
2. Все данные неизменяемые (запрещаем операцию UPDATE, в место нее делаем INSERT, чтобы не получилось так, что UPDATE придет на старый шард, который не будет перенесен) - пишем в target(то куда переливаем данные), а читаем из scr и target
3. Логическая репликация с src на tgt, после синхронизации переключаемся на tgt
4. Смешанный подход
