#SystemDesign 

### Функциональные требования
- посты с текстами и картинками
- просмотр домашней ленты и ленты пользователей
- отображаем посты в обратном хронологическом порядке
- поддерживаем комментарии и лайки

### Нефункциональные требования
- DAU 50 000 000
- Avaliability 99.95%
- Посты храним всегда
- Комментарии не ограничиваем
- Максимальное кол-во друзей 1000 000
- Максимальное кол-во букв в посте 2 000
- Одно изображение в посте
- В среднем пользователь создает один пост в 5 дней
- Пользователь просматривает ленту 10 раз в день (read intensive система)
- Геораспределенность на центральный и восточный регионы России
- Сезонности нет

[[lenta-vkontakte-design]]

>[!info]- Хранение картинок
> Картинки лучше сразу загружать через отдельный сервис в S3 хранилище, так как потом будет проще развивать эту систему(если захотим так же постить аудио или видео файлы). Отправка медиа файла будет осуществляться сразу, следовательно, чтобы избежать ситуации, когда пользователь передумал публиковать пост, а файл уже был загружен в БД. Хорошим решением будет сделать бакет хранилище, которое будет хранить загруженные для постов файлы, воркер будет перемещать их в постоянное хранилище, если пост с таким медиа файлом был создан. Оставшиеся файлы в таблице можно будет дропать

При дизайне соц сетей важно помнить, что при разделении write-read запросов репликация тоже имеет ограничения, чем больше реплик тем больше затраты на синхронизацию данных. При шардировании БД могут быть проблемы с большими запросами(показать ленту новостей пользователя), так как тяжело собирать данные в кучу. 

>Чаще всего проблема решается предварительным формированием(кеш) ленты новостей!

>[!info]- Проблема селебрити. Что делать?
>Если юзер с 1 млн подписчиков делает пост, то система будет делать 1 млн запросов обновления ленты новостей. 
>Чтобы избежать падений, когда селебрити делает пост, мы помещаем его только в его user_feed. Когда подписчик селебрити заходит в приложение Feed Service при выгрузке его ленты новостей смотрит дату последнего поста в ней и сравнивает ее с датами последних постов селебрити, на которых он подписан. Если 1 дата раньше, то подгружает посты селеб в его ленту

> Узнать от какого кол-ва подписчиков считать пользователя селебой покажется практическая эксплуатация :)

### Как пропускать данные через Кафку?

Несколько партиций по User_id или Post_id. Распределяем их по кластеру, при необходимости добавляем брокеров

## Геораспределенность

[[geo-lenta-vk]]

- Делаем 2 дата центра, так как надо захватить центральный и восточный регионы России. 
- Для синхронизации данных, пишем одновременно в оба мастера в дата центрах(для БД с постами).
- Для БД с лайками большой поток на запись, по этому можно синхронизировать между дата центрами. Касательно комментов, лучше разделить БД, чтобы не терять комменты(так же синкаем их синхронно master-master)
- Кеш с лентами пользователей синкать не нужно, так как пользователь будет роутиться в конкретный дата центр. Нет смысла хранить его home_feed в обоих дата центрах.
- Кафка должна синкаться между дата центрами, через нее роутятся пользователи 
- S3 тоже синкаем между собой с помощью CDN по пулл модели
