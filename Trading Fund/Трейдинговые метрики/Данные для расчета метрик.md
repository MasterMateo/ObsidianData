### 1. Рыночные данные

- **Исторические данные по ценам криптоактивов:**
    - **Поля:** временная метка, цена открытия, максимум, минимум, цена закрытия, объём торгов.
    - **Назначение:** позволяют рассчитывать доходности, волатильность, максимальные просадки и VaR.
- **Данные ордербука (при необходимости):**
    - **Поля:** лучшие цены на покупку/продажу, объёмы, временные метки.
    - **Назначение:** анализ ликвидности и расчёт скользящей цены (slippage).

### 2. Данные портфеля

- **История изменения стоимости портфеля (NAV):**
    - **Поля:** временная метка, стоимость портфеля (NAV).
    - **Назначение:** расчёт общей и годовой доходности, волатильности и максимальной просадки.
- **Распределение капиталовложений:**
    - **Поля:** идентификатор стратегии, сумма инвестиций, процентное соотношение в портфеле.
    - **Назначение:** оценка диверсификации и вклада каждой стратегии в общий результат.

### 3. Данные по сделкам и ордерам

- **Логи ордеров и сделок:**
    - **Поля:** идентификатор ордера, время подачи, ожидаемая цена, время исполнения, фактическая цена исполнения, объём, статус исполнения (полностью, частично, не исполнено).
    - **Назначение:**
        - Расчёт задержки исполнения (latency) с использованием микротаймстемпов.
        - Определение скользящей цены (slippage) — разница между ожидаемой и фактической ценой.
        - Анализ fill rate (процент полностью исполненных ордеров).
- **Детализация сделок по стратегиям:**
    - **Поля:** идентификатор сделки, идентификатор стратегии, валютная пара, объем сделки, цена, временная метка.
    - **Назначение:** разбиение метрик по отдельным стратегиям, анализ их индивидуальной доходности и риска.

### 4. Дополнительные данные для расчёта эффективности

- **Бенчмарк (рыночный индекс):**
    - **Поля:** временная метка, цена или значение индекса, объём (если применимо).
    - **Назначение:** расчёт Alpha и Beta через сравнение с рыночной доходностью.
- **Безрисковая ставка:**
    - **Поля:** ставка, применимая для данного периода (например, данные центрального банка).
    - **Назначение:** используется в расчёте Sharpe Ratio (разница доходности фонда и безрисковой ставки).
- **Комиссии и транзакционные расходы:**
    - **Поля:** тип комиссии, размер комиссии, временная метка сделки.
    - **Назначение:** корректировка расчёта доходности и влияние на торговые результаты.


```SQL
-- ====================================================================
-- 1. LOOK-UP ТАБЛИЦЫ
-- ====================================================================

-- Биржи
CREATE TABLE exchange (
    exchange_id SERIAL PRIMARY KEY,
    code TEXT UNIQUE NOT NULL                    -- 'BINANCE', 'BYBIT', ...
);

-- Инструменты
CREATE TABLE instrument (
    instrument_id SERIAL PRIMARY KEY,
    exchange_id INT NOT NULL REFERENCES exchange(exchange_id),
    symbol TEXT NOT NULL,
    UNIQUE (exchange_id, symbol)                -- Уникальная пара биржа + символ
);

-- Стратегии
CREATE TABLE strategy (
    strategy_id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

-- ====================================================================
-- 2. WALK-FORWARD: ЗАПУСКИ
-- ====================================================================
CREATE TYPE wf_status AS ENUM ('running', 'finished', 'crashed');

CREATE TABLE wf_run (
    run_id SERIAL PRIMARY KEY,
    strategy_id INT NOT NULL REFERENCES strategy(strategy_id),
    instrument_id INT NOT NULL REFERENCES instrument(instrument_id),
    tf_min SMALLINT NOT NULL CHECK (tf_min BETWEEN 1 AND 240),  -- Таймфрейм от 1 до 240 минут

    time_start TIMESTAMPTZ,         -- Начало периода тестирования
    time_end TIMESTAMPTZ,           -- Конец периода тестирования

    param_json JSONB,               -- Полный набор параметров

    created_at TIMESTAMPTZ DEFAULT now()
    status wf_status NOT NULL DEFAULT 'running'
);

CREATE INDEX ON wf_run (strategy_id);
CREATE INDEX ON wf_run (instrument_id, tf_min);

-- ====================================================================
-- 3. WALK-FORWARD: РЕЗУЛЬТАТЫ И ЭКВИТИ
-- ====================================================================

-- Основные метрики результатов по запуску
CREATE TABLE wf_results (
    run_id INT PRIMARY KEY REFERENCES wf_run(run_id),

    pnl NUMERIC(20,8),                         -- Финальный PnL
    max_drawdown NUMERIC(20,8),               -- Максимальный дроу-даун
    trade_count INT,                          -- Количество сделок
    longest_time_in_position INTERVAL,        -- Самое длинное время удержания позиции
    mar NUMERIC(10,6),                         -- PnL / Max Drawdown
    rpdn NUMERIC(10,6),                        -- Коэффициент детерминации (R²) equity
    win_rate NUMERIC(5,2)                      -- Процент выигрышных сделок (0–100)
);

-- Кривая equity (по часам/дням/TF)
CREATE TABLE equity_snapshot (
    run_id INT NOT NULL REFERENCES wf_run(run_id),
    ts TIMESTAMPTZ NOT NULL,                   -- Метка времени
    equity NUMERIC(20,4) NOT NULL,             -- Значение equity на конец периода

    PRIMARY KEY (run_id, ts)
);

CREATE INDEX ON equity_snapshot (ts);

-- ====================================================================
-- 4. WALK-FORWARD: СДЕЛКИ
-- ====================================================================

CREATE TABLE wf_trade (
    run_id INT NOT NULL REFERENCES wf_run(run_id),
    trade_id BIGSERIAL PRIMARY KEY,             -- Уникальный ID сделки в рамках запуска

    ts_trade TIMESTAMPTZ NOT NULL,              -- Момент исполнения сделки

    contracts INT NOT NULL,                     -- Кол-во контрактов после сделки: +N (лонг), -N (шорт), 0 (закрытие)
    price_close NUMERIC(20,8),                  -- Цена исполнения (закрытия/переворота)
    pnl NUMERIC(20,8)                            -- Фиксированный PnL сделки
);

CREATE INDEX ON wf_trade (run_id, ts_trade);
```